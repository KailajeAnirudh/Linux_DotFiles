/*******************************************************
* Copyright (C) 2018-2024 WP Interactive Media, Inc. - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
*******************************************************/
(()=>{"use strict";var t,e=function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function c(t){try{s(n.next(t))}catch(t){r(t)}}function a(t){try{s(n.throw(t))}catch(t){r(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(c,a)}s((n=n.apply(t,e||[])).next())}))};function i(){return e(this,void 0,void 0,(function*(){var t=[];try{const o=yield fetch("https://www.netflix.com/manageaccountaccess"),r=yield o.text();for(var e=(new DOMParser).parseFromString(r,"text/html").querySelectorAll(".device-list-item"),i=0;i<e.length;i++){var n={};n.deviceDescription=e[i].querySelector("h2").innerText,n.lastWatched=e[i].querySelector(".last-watched").innerText,n.profileName=e[i].querySelector(".profile-name").innerText,t.push(n)}}catch(t){return}return t}))}function n(t=0){return e(this,void 0,void 0,(function*(){try{let i=[];const n=yield fetch("https://www.netflix.com/YourAccount"),o=yield n.text(),r=(new DOMParser).parseFromString(o,"text/html");let c=[];return r.querySelectorAll(".profile-link[href*='viewed'").forEach((t=>{c.push(t.href.split("viewed/")[1])})),yield Promise.all(c.map((n=>e(this,void 0,void 0,(function*(){const o=[];let r;const c=t?50:1e4,a=(i=0)=>e(this,void 0,void 0,(function*(){try{const e=yield fetch(`https://www.netflix.com/api/shakti/mre/viewingactivity?pg=${i}&pgsize=${c}&guid=${n}`),s=yield e.json();n=s.profileInfo.guid,r=s.profileInfo.profileName;let d=s.viewedItems.filter((e=>e.date>t));if(o.push(...d),s.viewedItems.length==c&&d.length===s.viewedItems.length)return yield a(i+1)}catch(t){}}));yield a(),i.push({guid:n,profileName:r,watchHistory:o})}))))),i}catch(t){return}}))}if(!window.tpBrowseInjected){window.tpBrowseInjected=!0,t=function(){if(null!=document.getElementById("native-party-button"))return;const t=document.querySelector("a.primary-button.playLink");if(null==t)return;const e=t.parentElement,i=document.createElement("button");i.setAttribute("style","background: linear-gradient(273.58deg, #9E55A0 0%, #EF3E3A 100%); color: #fff; border-style: none; border-radius: 0.375rem; padding: 1.1rem; display: flex; align-items: center; justify-content: center; max-height: 45px;"),i.setAttribute("id","native-party-button"),i.setAttribute("class","hasLabel");const n=document.querySelector("a.primary-button.playLink span"),o=document.createElement("span");return o.innerText="Start a Teleparty",o.setAttribute("style","line-height: 1.7rem; font-size: 1.4rem; text-wrap: nowrap"),o.setAttribute("class",n.getAttribute("class")),e.insertBefore(i,t.nextSibling),i.appendChild(o),[{button:i,play:()=>t.click()}]},setInterval((()=>{try{const e=t();if(e)for(const t of e)t.button.addEventListener("click",(()=>{t.play();const e=setTimeout((()=>{window.postMessage({type:"startPartyNative"},"*"),clearTimeout(e)}),2e3);window.addEventListener("message",(t=>{var i;"startPartyMessageReceived"===(null===(i=t.data)||void 0===i?void 0:i.type)&&clearTimeout(e)})),t.button.removeEventListener("click",(()=>{}))}))}catch(t){}}),500),window.postMessage({type:"tpNetflixBrowseReady"},"*");{const t=t=>e(void 0,void 0,void 0,(function*(){const[e,o]=yield Promise.all([i(),n(t)]);window.postMessage({type:"tpSetNetflixData",data:{deviceList:e,watchHistoryList:o}},"*")}));window.addEventListener("message",(e=>{if("tpLoadNetflixData"===e.data.type){const i=e.data.lastFetch;t(i)}}))}}})();